<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Robot Simulator - Industrial Control</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body class="simulator-layout">
    <div class="toolbar">
        <div class="toolbar-group">
            <button class="tool-btn" onclick="loadSTLDialog()" title="Load STL Model">
                <span class="icon">üìÅ</span> Load STL
            </button>
            <button class="tool-btn" onclick="playSimulation()" title="Play Simulation">
                <span class="icon">‚ñ∂</span> Play
            </button>
            <button class="tool-btn" onclick="pauseSimulation()" title="Pause">
                <span class="icon">‚è∏</span> Pause
            </button>
            <button class="tool-btn" onclick="stopSimulation()" title="Stop">
                <span class="icon">‚èπ</span> Stop
            </button>
        </div>
        <div class="toolbar-group">
            <button class="tool-btn" onclick="resetCamera()" title="Reset View">
                <span class="icon">üîÑ</span> Reset View
            </button>
            <button class="tool-btn" onclick="toggleFrames()" title="Toggle Coordinate Frames">
                <span class="icon">üìê</span> Frames
            </button>
            <button class="tool-btn" onclick="exportSession()" title="Export Session">
                <span class="icon">üíæ</span> Export
            </button>
        </div>
        <div class="status-indicator-toolbar" id="connection-status-toolbar">
            <span class="status-dot" id="status-dot-toolbar"></span>
            <span id="status-text-toolbar">Connecting...</span>
        </div>
    </div>

    <div class="main-container">
        <aside class="left-panel">
            <div class="panel-header">
                <h3>Project Tree</h3>
            </div>
            <div class="tree-view">
                <div class="tree-node expanded" data-node="robot">
                    <div class="tree-node-header" onclick="toggleTreeNode(this)">
                        <span class="tree-icon">‚ñº</span>
                        <span class="tree-label">ü§ñ Robot Arm</span>
                    </div>
                    <div class="tree-node-children">
                        <div class="tree-leaf" id="joint-tree-0">
                            <span class="joint-icon">‚öô</span> Joint 0: <span class="joint-value">0.0¬∞</span>
                        </div>
                        <div class="tree-leaf" id="joint-tree-1">
                            <span class="joint-icon">‚öô</span> Joint 1: <span class="joint-value">0.0¬∞</span>
                        </div>
                        <div class="tree-leaf" id="joint-tree-2">
                            <span class="joint-icon">‚öô</span> Joint 2: <span class="joint-value">0.0¬∞</span>
                        </div>
                        <div class="tree-leaf" id="joint-tree-3">
                            <span class="joint-icon">‚öô</span> Joint 3: <span class="joint-value">0.0¬∞</span>
                        </div>
                        <div class="tree-leaf" id="joint-tree-4">
                            <span class="joint-icon">‚öô</span> Joint 4: <span class="joint-value">0.0¬∞</span>
                        </div>
                        <div class="tree-leaf" id="joint-tree-5">
                            <span class="joint-icon">‚öô</span> Joint 5: <span class="joint-value">0.0¬∞</span>
                        </div>
                        <div class="tree-leaf">
                            <span class="tcp-icon">üéØ</span> TCP (Tool Center Point)
                        </div>
                    </div>
                </div>

                <div class="tree-node" data-node="frames">
                    <div class="tree-node-header" onclick="toggleTreeNode(this)">
                        <span class="tree-icon">‚ñ∂</span>
                        <span class="tree-label">üìê Reference Frames</span>
                    </div>
                    <div class="tree-node-children" style="display: none;">
                        <div class="tree-leaf">Base Frame</div>
                        <div class="tree-leaf">Tool Frame</div>
                    </div>
                </div>

                <div class="tree-node" data-node="planes">
                    <div class="tree-node-header" onclick="toggleTreeNode(this)">
                        <span class="tree-icon">‚ñ∂</span>
                        <span class="tree-label">‚úà User Planes</span>
                    </div>
                    <div class="tree-node-children" style="display: none;" id="planes-list">
                        <div class="tree-leaf empty">No planes defined</div>
                    </div>
                </div>

                <div class="tree-node" data-node="points">
                    <div class="tree-node-header" onclick="toggleTreeNode(this)">
                        <span class="tree-icon">‚ñ∂</span>
                        <span class="tree-label">üìç Taught Points</span>
                    </div>
                    <div class="tree-node-children" style="display: none;" id="points-list">
                        <div class="tree-leaf empty">No points saved</div>
                    </div>
                </div>

                <div class="tree-node" data-node="stl">
                    <div class="tree-node-header" onclick="toggleTreeNode(this)">
                        <span class="tree-icon">‚ñ∂</span>
                        <span class="tree-label">üì¶ STL Models</span>
                    </div>
                    <div class="tree-node-children" style="display: none;" id="stl-list">
                        <div class="tree-leaf empty">No STL loaded</div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="center-panel">
            <div id="simulation-container"></div>
            <div class="simulation-overlay">
                <div class="overlay-info">
                    <div class="info-badge">
                        <strong>Mode:</strong> <span id="sim-mode">MODE 1</span>
                    </div>
                    <div class="info-badge">
                        <strong>Status:</strong> <span id="sim-status">Ready</span>
                    </div>
                </div>
                <div class="deviation-panel" id="deviation-panel" style="display: none;">
                    <h4>Simulation vs Reality</h4>
                    <div id="deviation-content"></div>
                </div>
            </div>
        </main>

        <aside class="right-panel">
            <div class="panel-tabs">
                <button class="tab-btn active" onclick="switchTab('motion')">Motion</button>
                <button class="tab-btn" onclick="switchTab('mode')">Mode</button>
                <button class="tab-btn" onclick="switchTab('config')">Config</button>
                <button class="tab-btn" onclick="switchTab('safety')">Safety</button>
            </div>

            <div class="tab-content" id="tab-motion">
                <h3>Motion Control</h3>
                
                <div class="control-group">
                    <label>Jog Joint</label>
                    <select id="jog-joint-select">
                        <option value="0">Joint 0</option>
                        <option value="1">Joint 1</option>
                        <option value="2">Joint 2</option>
                        <option value="3">Joint 3</option>
                        <option value="4">Joint 4</option>
                        <option value="5">Joint 5</option>
                    </select>
                    <div class="jog-buttons">
                        <button class="jog-btn" onclick="jogJoint(-1)">‚óÄ -</button>
                        <button class="jog-btn" onclick="jogJoint(1)">+ ‚ñ∂</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>Speed: <span id="speed-value">30</span> deg/s</label>
                    <input type="range" id="speed-slider" min="5" max="120" value="30" 
                           oninput="updateSpeedValue(this.value)">
                </div>

                <div class="control-group">
                    <label>Acceleration: <span id="accel-value">100</span> deg/s¬≤</label>
                    <input type="range" id="accel-slider" min="50" max="500" value="100" step="10"
                           oninput="updateAccelValue(this.value)">
                </div>

                <div class="control-group">
                    <label>Cartesian Target</label>
                    <input type="number" id="cart-x" placeholder="X (mm)" value="300">
                    <input type="number" id="cart-y" placeholder="Y (mm)" value="0">
                    <input type="number" id="cart-z" placeholder="Z (mm)" value="250">
                    <button class="primary-btn" onclick="moveCartesianFromPanel()">Move Linear</button>
                </div>

                <div class="control-group">
                    <button class="danger-btn" onclick="stopMotion()">‚èπ STOP ALL</button>
                </div>
            </div>

            <div class="tab-content" id="tab-mode" style="display: none;">
                <h3>Operating Mode</h3>
                <div class="mode-selector">
                    <div class="mode-card" onclick="setMode(1)">
                        <div class="mode-icon">üîì</div>
                        <div class="mode-title">Mode 1</div>
                        <div class="mode-desc">Open Loop<br>Time-based</div>
                    </div>
                    <div class="mode-card" onclick="setMode(2)">
                        <div class="mode-icon">üîí</div>
                        <div class="mode-title">Mode 2</div>
                        <div class="mode-desc">Closed Loop<br>IK + Encoders</div>
                    </div>
                </div>
                <div class="info-box">
                    <strong>Current Mode:</strong> <span id="current-mode-display">MODE 1</span>
                </div>
            </div>

            <div class="tab-content" id="tab-config" style="display: none;">
                <h3>Configuration</h3>
                <div class="control-group">
                    <label>Edit Joint Limits</label>
                    <select id="config-joint-select">
                        <option value="0">Joint 0</option>
                        <option value="1">Joint 1</option>
                        <option value="2">Joint 2</option>
                        <option value="3">Joint 3</option>
                        <option value="4">Joint 4</option>
                        <option value="5">Joint 5</option>
                    </select>
                    <input type="number" id="limit-min" placeholder="Min (deg)" value="-180">
                    <input type="number" id="limit-max" placeholder="Max (deg)" value="180">
                    <button class="secondary-btn" onclick="updateLimits()">Update Limits</button>
                </div>
                <div class="control-group">
                    <button class="primary-btn" onclick="saveConfigToESP32()">üíæ Save to ESP32</button>
                </div>
            </div>

            <div class="tab-content" id="tab-safety" style="display: none;">
                <h3>Safety Controls</h3>
                <div class="safety-status">
                    <div class="status-item">
                        <span class="status-label">Homed:</span>
                        <span class="status-value" id="safety-homed">No</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Motion Allowed:</span>
                        <span class="status-value" id="safety-motion">Yes</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Faults:</span>
                        <span class="status-value" id="safety-faults">0x00000000</span>
                    </div>
                </div>
                <div class="control-group">
                    <button class="danger-btn large" onclick="emergencyStop()">
                        üõë EMERGENCY STOP
                    </button>
                    <button class="warning-btn" onclick="clearFault()">
                        ‚úì Clear Fault
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <div id="stl-dialog" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" onclick="closeSTLDialog()">&times;</span>
            <h2>Load STL Model</h2>
            <div class="stl-upload-form">
                <label>Select Joint:</label>
                <select id="stl-joint-select">
                    <option value="base">Base</option>
                    <option value="0">Joint 0</option>
                    <option value="1">Joint 1</option>
                    <option value="2">Joint 2</option>
                    <option value="3">Joint 3</option>
                    <option value="4">Joint 4</option>
                    <option value="5">Joint 5</option>
                    <option value="tool">Tool/TCP</option>
                </select>
                <label>Upload STL File:</label>
                <input type="file" id="stl-file-input" accept=".stl">
                <button class="primary-btn" onclick="uploadSTL()">Load Model</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script src="simulator.js"></script>
</body>
</html>

        <div class="grid">
            <div class="card">
                <h2>System Status</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Mode:</span>
                        <span class="value" id="mode">Unknown</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Homed:</span>
                        <span class="value" id="homed">No</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Moving:</span>
                        <span class="value" id="moving">No</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Faults:</span>
                        <span class="value" id="faults">0x00000000</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Emergency Controls</h2>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="stopMotion()">‚èπ STOP ALL</button>
                    <button class="btn btn-danger" onclick="emergencyStop()">üõë E-STOP</button>
                    <button class="btn btn-success" onclick="clearFault()">‚úì Clear Fault</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Joint Control</h2>
            <div id="joint-controls"></div>
        </div>

        <div class="card">
            <h2>Cartesian Control (MODE 2 Only)</h2>
            <div class="input-grid">
                <div class="input-group">
                    <label for="target-x">X (mm):</label>
                    <input type="number" id="target-x" value="300" step="10">
                </div>
                <div class="input-group">
                    <label for="target-y">Y (mm):</label>
                    <input type="number" id="target-y" value="0" step="10">
                </div>
                <div class="input-group">
                    <label for="target-z">Z (mm):</label>
                    <input type="number" id="target-z" value="250" step="10">
                </div>
                <div class="input-group">
                    <label for="cart-velocity">Velocity (mm/s):</label>
                    <input type="number" id="cart-velocity" value="50" step="5">
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="moveCartesian(false)">‚ûú Move Linear</button>
                <button class="btn btn-secondary" onclick="moveCartesian(true)">‚úà Move on Plane</button>
            </div>
        </div>

        <div class="card">
            <h2>Plane Definition</h2>
            <div class="plane-controls">
                <div class="input-grid">
                    <div class="input-group">
                        <label>Point 1:</label>
                        <input type="text" id="p1" value="100,0,200" placeholder="x,y,z">
                    </div>
                    <div class="input-group">
                        <label>Point 2:</label>
                        <input type="text" id="p2" value="200,100,200" placeholder="x,y,z">
                    </div>
                    <div class="input-group">
                        <label>Point 3:</label>
                        <input type="text" id="p3" value="100,100,200" placeholder="x,y,z">
                    </div>
                    <div class="input-group">
                        <label>Name:</label>
                        <input type="text" id="plane-name" value="Workbench" placeholder="Plane name">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="definePlane()">Define Plane</button>
            </div>
        </div>

        <div class="card">
            <h2>Mode Selection</h2>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="setMode(1)">Mode 1 (Open Loop)</button>
                <button class="btn btn-secondary" onclick="setMode(2)">Mode 2 (Closed Loop)</button>
            </div>
            <p class="note">Note: MODE 2 requires encoders and homing</p>
        </div>

        <div class="card">
            <h2>Session Management (MODE 2)</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="exportSession()">üìä Export Session Data</button>
                <button class="btn btn-warning" onclick="resetSession()">üîÑ Reset Session</button>
            </div>
            <p class="note">Export accuracy metrics and deviation data</p>
        </div>

        <div class="card">
            <h2>3D Surface Streaming</h2>
            <p class="note">Upload STL/point cloud in external tool, stream waypoints here</p>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="alert('Use external CAD tool to generate waypoints')">
                    üìê Stream Surface
                </button>
            </div>
        </div>

        <div class="card">
            <h2>Cartesian Position</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">X:</span>
                    <span class="value" id="cart-x">0.0 mm</span>
                </div>
                <div class="info-item">
                    <span class="label">Y:</span>
                    <span class="value" id="cart-y">0.0 mm</span>
                </div>
                <div class="info-item">
                    <span class="label">Z:</span>
                    <span class="value" id="cart-z">0.0 mm</span>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>ESP32 Robotic Arm | Firmware v1.0 | <span id="uptime">0s</span></p>
    </footer>

    <script src="app.js"></script>
</body>
</html>