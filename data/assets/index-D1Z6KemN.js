const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RobotSimulator-D12WgcEY.js","assets/vendor-three-CQaKo-2P.js","assets/vendor-react-F9Y4d3HK.js","assets/ConnectionsGraph-BTBOpMXR.js","assets/vendor-flow-BwqUM98z.js","assets/ConnectionsGraph-B5DZHykP.css","assets/GeometryConfigPanel-DNHe9h9n.js","assets/MotionPanel-BtFtbDI0.js","assets/DiagnosticsPanel-BpymazFd.js"])))=>i.map(i=>d[i]);
import{a as W,j as s,_ as y,b as V}from"./vendor-three-CQaKo-2P.js";import{r as m,R as F}from"./vendor-react-F9Y4d3HK.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function e(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function a(i){if(i.ep)return;i.ep=!0;const l=e(i);fetch(i.href,l)}})();const E=W((t,n)=>({connected:!1,latencyMs:0,lastUpdateMs:0,simulatorMode:!1,hardwareArmed:!1,modeChangePending:!1,modeChangeError:null,mode:"MODE_1_OPEN_LOOP",isMoving:!1,isHomed:!1,motionAllowed:!0,faultCode:0,jointPositions:[0,0,0,0,0,0],jointVelocities:[0,0,0,0,0,0],jointTargets:[0,0,0,0,0,0],tcpPosition:[0,0,0],tcpOrientation:[0,0,0],motorType:"SERVO",activeFrame:"BASE",activeIKSolver:"NUMERICAL",ikPreference:"ACCURACY",lastIKResult:null,ikPreviewEnabled:!0,aligned:!0,alignmentWarning:!1,alignmentCritical:!1,speedModifier:1,maxJointError:0,tcpError:0,estopActive:!1,selectedJoint:0,jogSpeed:30,cartesianTarget:[300,0,250],showGhostRobot:!1,ghostJoints:[0,0,0,0,0,0],graphNodes:[],graphEdges:[],selectedNode:null,setConnected:e=>t({connected:e}),setLatency:e=>t({latencyMs:e}),requestModeChange:e=>{t({modeChangePending:!0,modeChangeError:null})},applyModeChange:e=>{e.success?t({simulatorMode:e.current_mode==="SIMULATOR",hardwareArmed:e.current_mode==="HARDWARE",modeChangePending:!1,modeChangeError:null}):t({modeChangePending:!1,modeChangeError:e.rejection_reason})},updateFromFirmware:e=>{var a,i,l,u,f;t({lastUpdateMs:Date.now(),mode:e.mode||n().mode,isMoving:e.is_moving??n().isMoving,isHomed:e.is_homed??n().isHomed,motionAllowed:e.motion_allowed??n().motionAllowed,faultCode:e.fault_code??n().faultCode,jointPositions:((a=e.joints)==null?void 0:a.positions_deg)||n().jointPositions,jointVelocities:((i=e.joints)==null?void 0:i.velocities_deg_s)||n().jointVelocities,jointTargets:((l=e.joints)==null?void 0:l.targets_deg)||n().jointTargets,tcpPosition:((u=e.tcp)==null?void 0:u.position_mm)||n().tcpPosition,tcpOrientation:((f=e.tcp)==null?void 0:f.orientation_deg)||n().tcpOrientation,motorType:e.motor_type||n().motorType,activeFrame:e.active_frame||n().activeFrame})},updateAlignment:e=>{t({aligned:e.aligned,alignmentWarning:e.warning,alignmentCritical:e.critical,speedModifier:e.speed_modifier,maxJointError:e.max_joint_error_deg,tcpError:e.tcp_error_mm})},updateSafety:e=>{t({faultCode:e.fault_code,estopActive:e.fault_name==="E_STOP_ACTIVE",motionAllowed:!e.motion_blocked})},setIKResult:e=>t({lastIKResult:e}),setIKSolver:e=>t({activeIKSolver:e}),setIKPreference:e=>t({ikPreference:e}),setGhostRobot:e=>t({showGhostRobot:!0,ghostJoints:e}),hideGhostRobot:()=>t({showGhostRobot:!1}),setSelectedJoint:e=>t({selectedJoint:e}),setJogSpeed:e=>t({jogSpeed:e}),setCartesianTarget:e=>t({cartesianTarget:e}),setActiveFrame:e=>t({activeFrame:e}),setGraphNodes:e=>t({graphNodes:e}),setGraphEdges:e=>t({graphEdges:e}),setSelectedNode:e=>t({selectedNode:e}),simulateJointMove:e=>{n().simulatorMode&&t({jointPositions:e})}})),o={jointPositions:[0,0,0,0,0,0],jointVelocities:[0,0,0,0,0,0],jointTargets:[0,0,0,0,0,0],isMoving:!1,motionProgress:0,motionStartTime:0,motionDuration:0,motionStartPositions:[0,0,0,0,0,0],faultCode:0,estopActive:!1,isHomed:!1,motionAllowed:!0,aligned:!0,alignmentWarning:!1,alignmentCritical:!1,maxJointError:0,speedModifier:1,motorType:"SERVO",operatingMode:"MODE_1_OPEN_LOOP"},v=[{min:-180,max:180,maxVel:120},{min:-90,max:90,maxVel:90},{min:-135,max:135,maxVel:100},{min:-180,max:180,maxVel:150},{min:-120,max:120,maxVel:120},{min:-180,max:180,maxVel:180}];let M={L1:150,L2:300,L3:250,L4:100};function J(t){M={...M,...t},console.log("[SIMULATED] DH params updated:",M)}function fe(){return{...M}}let L=[...v];function ge(t){L=t.map((n,e)=>({...v[e],...n})),console.log("[SIMULATED] Joint limits updated:",L)}function pe(){return L.map(t=>({...t}))}function G(t){const n=t.map(d=>d*Math.PI/180),e=Math.cos(n[0]),a=Math.sin(n[0]),i=Math.cos(n[1]),l=Math.sin(n[1]);Math.cos(n[2]),Math.sin(n[2]);const u=M.L2*i+M.L3*Math.cos(n[1]+n[2]),f=M.L1+M.L2*l+M.L3*Math.sin(n[1]+n[2]),h=u*e,r=u*a;return{position:[h,r,f],orientation:[t[3],t[4],t[5]]}}function D(t,n){const e=t[0],a=t[1],i=t[2],l=Math.atan2(a,e)*180/Math.PI,u=Math.sqrt(e*e+a*a),f=i-M.L1,h=Math.sqrt(u*u+f*f),r=M.L2,d=M.L3;if(h>r+d*.99||h<Math.abs(r-d)*1.01)return{feasible:!1,error_code:2,error_message:"Target unreachable"};let p=(h*h-r*r-d*d)/(2*r*d);p=Math.max(-1,Math.min(1,p));const _=Math.atan2(Math.sqrt(1-p*p),p)*180/Math.PI,S=Math.atan2(f,u),x=Math.atan2(d*Math.sin(_*Math.PI/180),r+d*Math.cos(_*Math.PI/180)),C=(S-x)*180/Math.PI,j=t[3]||0,T=t[4]||0,w=t[5]||0,A=[b(l),b(C),b(_),b(j),b(T),b(w)];for(let c=0;c<6;c++)if(A[c]<v[c].min||A[c]>v[c].max)return{feasible:!1,error_code:3,error_message:`Joint ${c} limit exceeded`,limiting_joint:c};const g=Math.abs(Math.sin(_*Math.PI/180));return{feasible:!0,joints_deg:A,velocities_deg_s:[30,40,35,20,25,30],confidence:g>.3?.9:.6,error_mm:.5,singularity_metric:g,singularity_warning:g<.15,joint_limit_warning:!1,limiting_joint:-1}}function b(t){for(;t>180;)t-=360;for(;t<-180;)t+=360;return t}function P(t,n=30){if(!o.motionAllowed||o.estopActive)return{success:!1,error:"Motion not allowed"};for(let a=0;a<6;a++)if(t[a]<v[a].min||t[a]>v[a].max)return{success:!1,error:`Joint ${a} limit exceeded`};let e=0;for(let a=0;a<6;a++){const i=Math.abs(t[a]-o.jointPositions[a]),l=Math.min(n,v[a].maxVel),u=i/l;u>e&&(e=u)}return o.motionStartPositions=[...o.jointPositions],o.jointTargets=[...t],o.motionStartTime=Date.now(),o.motionDuration=e*1e3,o.isMoving=!0,o.motionProgress=0,{success:!0,duration:e}}function K(){if(!o.isMoving)return;const t=Date.now()-o.motionStartTime,n=Math.min(1,t/o.motionDuration),e=(1-Math.cos(n*Math.PI))/2;for(let a=0;a<6;a++){const i=o.motionStartPositions[a],l=o.jointTargets[a];if(o.jointPositions[a]=i+(l-i)*e,o.motionDuration>0){const u=l-i,f=Math.sin(n*Math.PI);o.jointVelocities[a]=u/(o.motionDuration/1e3)*f*1.57}}o.motionProgress=n,n>=1&&(o.isMoving=!1,o.jointVelocities=[0,0,0,0,0,0])}function U(){o.isMoving=!1,o.jointTargets=[...o.jointPositions],o.jointVelocities=[0,0,0,0,0,0]}function H(){U(),o.faultCode=32,o.estopActive=!0,o.motionAllowed=!1}function q(){o.faultCode=0,o.estopActive=!1,o.motionAllowed=!0}function $(){let n=0;for(let e=0;e<6;e++){const a=(Math.random()-.5)*.3,i=Math.abs(a);i>n&&(n=i)}o.maxJointError=n,n>5?(o.alignmentCritical=!0,o.alignmentWarning=!0,o.aligned=!1,o.speedModifier=0):n>2?(o.alignmentCritical=!1,o.alignmentWarning=!0,o.aligned=!1,o.speedModifier=.5):(o.alignmentCritical=!1,o.alignmentWarning=!1,o.aligned=!0,o.speedModifier=1)}function z(){const t=G(o.jointPositions);return{version:1,timestamp_ms:Date.now(),type:"STATE_UPDATE",payload:{mode:o.operatingMode,is_moving:o.isMoving,is_homed:o.isHomed,motion_allowed:o.motionAllowed,fault_code:o.faultCode,joints:{positions_deg:[...o.jointPositions],velocities_deg_s:[...o.jointVelocities],targets_deg:[...o.jointTargets]},tcp:{position_mm:t.position,orientation_deg:t.orientation},motor_type:o.motorType,active_frame:"BASE"}}}function B(){return{version:1,timestamp_ms:Date.now(),type:"ALIGNMENT_STATUS",payload:{aligned:o.aligned,warning:o.alignmentWarning,critical:o.alignmentCritical,speed_modifier:o.speedModifier,max_joint_error_deg:o.maxJointError,worst_joint:0,tcp_error_mm:o.maxJointError*2,fault_code:o.alignmentCritical?64:0,fault_message:o.alignmentCritical?"Alignment critical":""}}}let R=!1;function Y(){const t=m.useRef(null),n=m.useRef(null),e=E;m.useEffect(()=>{if(R)return;R=!0,e.getState().setConnected(!0),e.getState().setLatency(0),e.getState().applyModeChange({success:!0,current_mode:"SIMULATOR"});const r=()=>{K();const p=z();e.getState().updateFromFirmware(p.payload)},d=()=>{$();const p=B();e.getState().updateAlignment(p.payload)};return t.current=setInterval(r,100),n.current=setInterval(d,500),r(),d(),()=>{R=!1,clearInterval(t.current),clearInterval(n.current)}},[]);const a=m.useCallback((r,d,p)=>{const _=D(r);return e.getState().setIKResult(_),_},[]),i=m.useCallback(r=>{r?e.getState().applyModeChange({success:!0,current_mode:"SIMULATOR"}):e.getState().applyModeChange({success:!1,current_mode:"SIMULATOR",rejection_reason:"No hardware connected - simulation only mode",rejection_code:99})},[]),l=m.useCallback(r=>{if(r.type==="joint_move")return P(r.targets,r.velocity||30);if(r.type==="cartesian_move"){const d=D(r.target);return d.feasible?P(d.joints_deg,r.velocity||30):{success:!1,error:d.error_message}}else{if(r.type==="stop")return U(),{success:!0};if(r.type==="estop")return H(),e.getState().updateFromFirmware({fault_code:o.faultCode,motion_allowed:!1}),e.getState().updateSafety({fault_code:o.faultCode,fault_name:"E_STOP_ACTIVE",motion_blocked:!0}),{success:!0};if(r.type==="clear_fault")return q(),e.getState().updateFromFirmware({fault_code:0,motion_allowed:!0}),e.getState().updateSafety({fault_code:0,fault_name:"",motion_blocked:!1}),{success:!0}}return{success:!1,error:"Unknown command"}},[]),u=m.useCallback((r,d,p=30)=>{const _=o.jointPositions[r],S=[...o.jointPositions];S[r]=_+d*5;const x=v[r];return S[r]=Math.max(x.min,Math.min(x.max,S[r])),P(S,p)},[]),f=m.useCallback(r=>(J(r),{success:!0}),[]);return{send:m.useCallback((r,d)=>(console.log("[SIMULATED] Message:",r,d),!0),[]),requestIKPreview:a,requestModeSwitch:i,sendMotionCommand:l,jogJoint:u,setRobotGeometry:f,isSimulated:!0}}const k=500,Q=1e4,X=500;function Z(t=null){const n=m.useRef(null),e=m.useRef(null),a=m.useRef(null),i=m.useRef(k),{setConnected:l,setLatency:u,updateFromFirmware:f,updateAlignment:h,updateSafety:r,setIKResult:d,applyModeChange:p,requestModeChange:_}=E(),S=t||`ws://${window.location.host}/ws`,x=m.useCallback(g=>{try{const c=JSON.parse(g.data);if(c.version!==1){console.warn("Unknown message version:",c.version);return}switch(c.timestamp_ms&&u(Date.now()-c.timestamp_ms),c.type){case"STATE_UPDATE":f(c.payload);break;case"ALIGNMENT_STATUS":h(c.payload);break;case"SAFETY_FAULT":r(c.payload);break;case"IK_PREVIEW_RESULT":d(c.payload);break;case"IK_FAILURE":d({feasible:!1,error_code:c.payload.error_code,error_message:c.payload.error_message});break;case"MODE_CHANGE_RESPONSE":p(c.payload);break;case"MODE_STATUS":p({success:!0,current_mode:c.payload.mode});break;default:console.log("Unknown message type:",c.type)}}catch(c){console.error("WebSocket message parse error:",c)}},[f,h,r,d,p,u]),C=m.useCallback(()=>{var g;if(((g=n.current)==null?void 0:g.readyState)!==WebSocket.OPEN)try{n.current=new WebSocket(S),n.current.onopen=()=>{console.log("[WS] Connected"),l(!0),i.current=k,a.current&&(clearTimeout(a.current),a.current=null)},n.current.onclose=()=>{console.log("[WS] Disconnected"),a.current||(a.current=setTimeout(()=>{l(!1),_(!0),console.warn("[WS] Grace period expired - entering safe mode")},X)),e.current=setTimeout(()=>{i.current=Math.min(i.current*2,Q),C()},i.current)},n.current.onerror=c=>{console.error("[WS] Error:",c)},n.current.onmessage=x}catch(c){console.error("[WS] Connection failed:",c)}},[S,l,x,_]),j=m.useCallback((g,c)=>{var O;if(((O=n.current)==null?void 0:O.readyState)!==WebSocket.OPEN)return console.warn("[WS] Cannot send - not connected"),!1;const N={version:1,timestamp_ms:Date.now(),type:g,payload:c};return n.current.send(JSON.stringify(N)),!0},[]),T=m.useCallback((g,c,N)=>j("IK_PREVIEW_REQUEST",{target_mm:g.slice(0,3),orientation_deg:g.slice(3,6),seed_joints_deg:c,solver:N}),[j]),w=m.useCallback(g=>j("MODE_CHANGE_REQUEST",{target_mode:g?"SIMULATOR":"HARDWARE",force:!1}),[j]),A=m.useCallback(g=>E.getState().simulatorMode?(console.warn("[WS] Motion command blocked - simulator mode"),!1):j("MOTION_COMMAND",g),[j]);return m.useEffect(()=>(C(),()=>{e.current&&clearTimeout(e.current),a.current&&clearTimeout(a.current),n.current&&n.current.close()}),[C]),{send:j,requestIKPreview:T,requestModeSwitch:w,sendMotionCommand:A}}function ee(){const{simulatorMode:t,hardwareArmed:n,modeChangePending:e,modeChangeError:a,isMoving:i,faultCode:l,estopActive:u}=E(),{requestModeSwitch:f}=Z(),h=!i&&!e&&!u,r=()=>{h&&(f(!t),E.getState().requestModeChange(!t))};let d=null;return i&&(d="Motion in progress"),e&&(d="Switching..."),u&&(d="E-Stop active"),s.jsxs("div",{className:"simulator-toggle",children:[s.jsxs("div",{className:"toggle-container",children:[s.jsxs("button",{className:`mode-button hardware ${t?"":"active"}`,onClick:()=>t&&r(),disabled:!h||!t,children:[s.jsx("span",{className:"mode-icon",children:"âš™ï¸"}),s.jsx("span",{className:"mode-label",children:"HARDWARE"}),n&&!t&&s.jsx("span",{className:"armed-indicator",children:"ARMED"})]}),s.jsx("div",{className:`toggle-switch ${t?"simulator":"hardware"} ${h?"":"disabled"}`,onClick:r,role:"switch","aria-checked":t,children:s.jsx("div",{className:"toggle-thumb"})}),s.jsxs("button",{className:`mode-button simulator ${t?"active":""}`,onClick:()=>!t&&r(),disabled:!h||t,children:[s.jsx("span",{className:"mode-icon",children:"ðŸŽ®"}),s.jsx("span",{className:"mode-label",children:"SIMULATOR"})]})]}),s.jsxs("div",{className:"toggle-status",children:[e&&s.jsx("span",{className:"status-pending",children:"Switching mode..."}),a&&s.jsx("span",{className:"status-error",children:a}),d&&!e&&s.jsx("span",{className:"status-blocked",children:d})]}),!t&&s.jsx("div",{className:"hardware-warning",children:"âš ï¸ Commands will move real motors"})]})}const te=m.lazy(()=>y(()=>import("./RobotSimulator-D12WgcEY.js"),__vite__mapDeps([0,1,2]))),oe=m.lazy(()=>y(()=>import("./ConnectionsGraph-BTBOpMXR.js"),__vite__mapDeps([3,1,2,4,5]))),ne=m.lazy(()=>y(()=>import("./GeometryConfigPanel-DNHe9h9n.js"),__vite__mapDeps([6,1,2]))),se=[{id:"simulator",label:"3D Simulator",icon:"ðŸ¤–"},{id:"connections",label:"Connections",icon:"ðŸ”—"},{id:"motion",label:"Motion",icon:"ðŸŽ¯"},{id:"geometry",label:"Geometry",icon:"ðŸ“"},{id:"diagnostics",label:"Diagnostics",icon:"ðŸ“Š"}];function ae(){const[t,n]=m.useState("simulator"),{connected:e,simulatorMode:a,faultCode:i,aligned:l,estopActive:u}=E();return Y(),s.jsxs("div",{className:"app-container",children:[s.jsxs("header",{className:"app-header",children:[s.jsxs("div",{className:"header-left",children:[s.jsx("h1",{className:"app-title",children:"ESP32 Robot Arm"}),s.jsx("span",{className:"app-subtitle",children:"Industrial Simulator"})]}),s.jsx("div",{className:"header-center",children:s.jsx(ee,{})}),s.jsxs("div",{className:"header-right",children:[s.jsx(ie,{connected:e}),s.jsx(re,{estop:u,fault:i!==0,aligned:l})]})]}),s.jsx("nav",{className:"tab-navigation",children:se.map(f=>s.jsxs("button",{className:`tab-button ${t===f.id?"active":""}`,onClick:()=>n(f.id),children:[s.jsx("span",{className:"tab-icon",children:f.icon}),s.jsx("span",{className:"tab-label",children:f.label})]},f.id))}),s.jsx("main",{className:"main-content",children:s.jsxs(m.Suspense,{fallback:s.jsx(ce,{}),children:[t==="simulator"&&s.jsx(te,{}),t==="connections"&&s.jsx(oe,{}),t==="motion"&&s.jsx(le,{}),t==="geometry"&&s.jsx(ne,{}),t==="diagnostics"&&s.jsx(de,{})]})}),s.jsxs("footer",{className:"status-bar",children:[s.jsx(I,{label:"Mode",value:a?"SIMULATOR":"HARDWARE"}),s.jsx(I,{label:"Lat",value:`${E.getState().latencyMs}ms`}),s.jsx(I,{label:"Fault",value:`0x${i.toString(16).padStart(8,"0")}`})]})]})}function ie({connected:t}){return s.jsxs("div",{className:`connection-status ${t?"connected":"disconnected"}`,children:[s.jsx("span",{className:"status-dot"}),s.jsx("span",{className:"status-text",children:t?"Connected":"Disconnected"})]})}function re({estop:t,fault:n,aligned:e}){let a="ok",i="Safe";return t?(a="estop",i="E-STOP"):n?(a="fault",i="FAULT"):e||(a="warning",i="Misaligned"),s.jsxs("div",{className:`safety-indicator ${a}`,children:[s.jsx("span",{className:"safety-icon",children:"âš¡"}),s.jsx("span",{className:"safety-text",children:i})]})}function I({label:t,value:n}){return s.jsxs("div",{className:"status-item",children:[s.jsxs("span",{className:"status-label",children:[t,":"]}),s.jsx("span",{className:"status-value",children:n})]})}function ce(){return s.jsxs("div",{className:"loading-spinner",children:[s.jsx("div",{className:"spinner"}),s.jsx("span",{children:"Loading..."})]})}const le=m.lazy(()=>y(()=>import("./MotionPanel-BtFtbDI0.js"),__vite__mapDeps([7,1,2]))),de=m.lazy(()=>y(()=>import("./DiagnosticsPanel-BpymazFd.js"),__vite__mapDeps([8,1,2])));V.createRoot(document.getElementById("root")).render(s.jsx(F.StrictMode,{children:s.jsx(ae,{})}));export{v as J,pe as a,ge as b,Y as c,fe as g,J as s,E as u};
