const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/RobotSimulator-BLi83Ft4.js","assets/vendor-three-CQaKo-2P.js","assets/vendor-react-F9Y4d3HK.js","assets/ConnectionsGraph-uyiXOfH1.js","assets/vendor-flow-BwqUM98z.js","assets/ConnectionsGraph-B5DZHykP.css","assets/MotionPanel-CVXXJhcS.js","assets/DiagnosticsPanel-B6K82A9o.js"])))=>i.map(i=>d[i]);
import{a as k,j as i,_ as y,b as W}from"./vendor-three-CQaKo-2P.js";import{r as u,R as U}from"./vendor-react-F9Y4d3HK.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function e(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function s(a){if(a.ep)return;a.ep=!0;const c=e(a);fetch(a.href,c)}})();const A=k((t,n)=>({connected:!1,latencyMs:0,lastUpdateMs:0,simulatorMode:!1,hardwareArmed:!1,modeChangePending:!1,modeChangeError:null,mode:"MODE_1_OPEN_LOOP",isMoving:!1,isHomed:!1,motionAllowed:!0,faultCode:0,jointPositions:[0,0,0,0,0,0],jointVelocities:[0,0,0,0,0,0],jointTargets:[0,0,0,0,0,0],tcpPosition:[0,0,0],tcpOrientation:[0,0,0],motorType:"SERVO",activeFrame:"BASE",activeIKSolver:"NUMERICAL",ikPreference:"ACCURACY",lastIKResult:null,ikPreviewEnabled:!0,aligned:!0,alignmentWarning:!1,alignmentCritical:!1,speedModifier:1,maxJointError:0,tcpError:0,estopActive:!1,selectedJoint:0,jogSpeed:30,cartesianTarget:[300,0,250],showGhostRobot:!1,ghostJoints:[0,0,0,0,0,0],graphNodes:[],graphEdges:[],selectedNode:null,setConnected:e=>t({connected:e}),setLatency:e=>t({latencyMs:e}),requestModeChange:e=>{t({modeChangePending:!0,modeChangeError:null})},applyModeChange:e=>{e.success?t({simulatorMode:e.current_mode==="SIMULATOR",hardwareArmed:e.current_mode==="HARDWARE",modeChangePending:!1,modeChangeError:null}):t({modeChangePending:!1,modeChangeError:e.rejection_reason})},updateFromFirmware:e=>{var s,a,c,d,m;t({lastUpdateMs:Date.now(),mode:e.mode||n().mode,isMoving:e.is_moving??n().isMoving,isHomed:e.is_homed??n().isHomed,motionAllowed:e.motion_allowed??n().motionAllowed,faultCode:e.fault_code??n().faultCode,jointPositions:((s=e.joints)==null?void 0:s.positions_deg)||n().jointPositions,jointVelocities:((a=e.joints)==null?void 0:a.velocities_deg_s)||n().jointVelocities,jointTargets:((c=e.joints)==null?void 0:c.targets_deg)||n().jointTargets,tcpPosition:((d=e.tcp)==null?void 0:d.position_mm)||n().tcpPosition,tcpOrientation:((m=e.tcp)==null?void 0:m.orientation_deg)||n().tcpOrientation,motorType:e.motor_type||n().motorType,activeFrame:e.active_frame||n().activeFrame})},updateAlignment:e=>{t({aligned:e.aligned,alignmentWarning:e.warning,alignmentCritical:e.critical,speedModifier:e.speed_modifier,maxJointError:e.max_joint_error_deg,tcpError:e.tcp_error_mm})},updateSafety:e=>{t({faultCode:e.fault_code,estopActive:e.fault_name==="E_STOP_ACTIVE",motionAllowed:!e.motion_blocked})},setIKResult:e=>t({lastIKResult:e}),setIKSolver:e=>t({activeIKSolver:e}),setIKPreference:e=>t({ikPreference:e}),setGhostRobot:e=>t({showGhostRobot:!0,ghostJoints:e}),hideGhostRobot:()=>t({showGhostRobot:!1}),setSelectedJoint:e=>t({selectedJoint:e}),setJogSpeed:e=>t({jogSpeed:e}),setCartesianTarget:e=>t({cartesianTarget:e}),setActiveFrame:e=>t({activeFrame:e}),setGraphNodes:e=>t({graphNodes:e}),setGraphEdges:e=>t({graphEdges:e}),setSelectedNode:e=>t({selectedNode:e}),simulateJointMove:e=>{n().simulatorMode&&t({jointPositions:e})}})),o={jointPositions:[0,0,0,0,0,0],jointVelocities:[0,0,0,0,0,0],jointTargets:[0,0,0,0,0,0],isMoving:!1,motionProgress:0,motionStartTime:0,motionDuration:0,motionStartPositions:[0,0,0,0,0,0],faultCode:0,estopActive:!1,isHomed:!1,motionAllowed:!0,aligned:!0,alignmentWarning:!1,alignmentCritical:!1,maxJointError:0,speedModifier:1,motorType:"SERVO",operatingMode:"MODE_1_OPEN_LOOP"},T=[{min:-180,max:180,maxVel:120},{min:-90,max:90,maxVel:90},{min:-135,max:135,maxVel:100},{min:-180,max:180,maxVel:150},{min:-120,max:120,maxVel:120},{min:-180,max:180,maxVel:180}],E={L1:150,L2:300,L3:250};function V(t){const n=t.map(f=>f*Math.PI/180),e=Math.cos(n[0]),s=Math.sin(n[0]),a=Math.cos(n[1]),c=Math.sin(n[1]);Math.cos(n[2]),Math.sin(n[2]);const d=E.L2*a+E.L3*Math.cos(n[1]+n[2]),m=E.L1+E.L2*c+E.L3*Math.sin(n[1]+n[2]),h=d*e,g=d*s;return{position:[h,g,m],orientation:[t[3],t[4],t[5]]}}function L(t,n){const e=t[0],s=t[1],a=t[2],c=Math.atan2(s,e)*180/Math.PI,d=Math.sqrt(e*e+s*s),m=a-E.L1,h=Math.sqrt(d*d+m*m),g=E.L2,f=E.L3;if(h>g+f*.99||h<Math.abs(g-f)*1.01)return{feasible:!1,error_code:2,error_message:"Target unreachable"};let S=(h*h-g*g-f*f)/(2*g*f);S=Math.max(-1,Math.min(1,S));const j=Math.atan2(Math.sqrt(1-S*S),S)*180/Math.PI,l=Math.atan2(m,d),_=Math.atan2(f*Math.sin(j*Math.PI/180),g+f*Math.cos(j*Math.PI/180)),v=(l-_)*180/Math.PI,M=t[3]||0,x=t[4]||0,b=t[5]||0,N=[C(c),C(v),C(j),C(M),C(x),C(b)];for(let r=0;r<6;r++)if(N[r]<T[r].min||N[r]>T[r].max)return{feasible:!1,error_code:3,error_message:`Joint ${r} limit exceeded`,limiting_joint:r};const p=Math.abs(Math.sin(j*Math.PI/180));return{feasible:!0,joints_deg:N,velocities_deg_s:[30,40,35,20,25,30],confidence:p>.3?.9:.6,error_mm:.5,singularity_metric:p,singularity_warning:p<.15,joint_limit_warning:!1,limiting_joint:-1}}function C(t){for(;t>180;)t-=360;for(;t<-180;)t+=360;return t}function P(t,n=30){if(!o.motionAllowed||o.estopActive)return{success:!1,error:"Motion not allowed"};for(let s=0;s<6;s++)if(t[s]<T[s].min||t[s]>T[s].max)return{success:!1,error:`Joint ${s} limit exceeded`};let e=0;for(let s=0;s<6;s++){const a=Math.abs(t[s]-o.jointPositions[s]),c=Math.min(n,T[s].maxVel),d=a/c;d>e&&(e=d)}return o.motionStartPositions=[...o.jointPositions],o.jointTargets=[...t],o.motionStartTime=Date.now(),o.motionDuration=e*1e3,o.isMoving=!0,o.motionProgress=0,{success:!0,duration:e}}function F(){if(!o.isMoving)return;const t=Date.now()-o.motionStartTime,n=Math.min(1,t/o.motionDuration),e=(1-Math.cos(n*Math.PI))/2;for(let s=0;s<6;s++){const a=o.motionStartPositions[s],c=o.jointTargets[s];if(o.jointPositions[s]=a+(c-a)*e,o.motionDuration>0){const d=c-a,m=Math.sin(n*Math.PI);o.jointVelocities[s]=d/(o.motionDuration/1e3)*m*1.57}}o.motionProgress=n,n>=1&&(o.isMoving=!1,o.jointVelocities=[0,0,0,0,0,0])}function D(){o.isMoving=!1,o.jointTargets=[...o.jointPositions],o.jointVelocities=[0,0,0,0,0,0]}function K(){D(),o.faultCode=32,o.estopActive=!0,o.motionAllowed=!1}function J(){o.faultCode=0,o.estopActive=!1,o.motionAllowed=!0}function G(){let n=0;for(let e=0;e<6;e++){const s=(Math.random()-.5)*.3,a=Math.abs(s);a>n&&(n=a)}o.maxJointError=n,n>5?(o.alignmentCritical=!0,o.alignmentWarning=!0,o.aligned=!1,o.speedModifier=0):n>2?(o.alignmentCritical=!1,o.alignmentWarning=!0,o.aligned=!1,o.speedModifier=.5):(o.alignmentCritical=!1,o.alignmentWarning=!1,o.aligned=!0,o.speedModifier=1)}function q(){const t=V(o.jointPositions);return{version:1,timestamp_ms:Date.now(),type:"STATE_UPDATE",payload:{mode:o.operatingMode,is_moving:o.isMoving,is_homed:o.isHomed,motion_allowed:o.motionAllowed,fault_code:o.faultCode,joints:{positions_deg:[...o.jointPositions],velocities_deg_s:[...o.jointVelocities],targets_deg:[...o.jointTargets]},tcp:{position_mm:t.position,orientation_deg:t.orientation},motor_type:o.motorType,active_frame:"BASE"}}}function $(){return{version:1,timestamp_ms:Date.now(),type:"ALIGNMENT_STATUS",payload:{aligned:o.aligned,warning:o.alignmentWarning,critical:o.alignmentCritical,speed_modifier:o.speedModifier,max_joint_error_deg:o.maxJointError,worst_joint:0,tcp_error_mm:o.maxJointError*2,fault_code:o.alignmentCritical?64:0,fault_message:o.alignmentCritical?"Alignment critical":""}}}function H(){const t=u.useRef(null),n=u.useRef(null),{setConnected:e,setLatency:s,updateFromFirmware:a,updateAlignment:c,setIKResult:d,applyModeChange:m}=A();u.useEffect(()=>(e(!0),s(0),m({success:!0,current_mode:"SIMULATOR"}),t.current=setInterval(()=>{F();const l=q();a(l.payload)},100),n.current=setInterval(()=>{G();const l=$();c(l.payload)},500),()=>{clearInterval(t.current),clearInterval(n.current)}),[e,s,a,c,m]);const h=u.useCallback((l,_,v)=>{const M=L(l);return d(M),!0},[d]),g=u.useCallback(l=>{m(l?{success:!0,current_mode:"SIMULATOR"}:{success:!1,current_mode:"SIMULATOR",rejection_reason:"No hardware connected - simulation only mode",rejection_code:99})},[m]),f=u.useCallback(l=>{if(l.type==="joint_move")return P(l.targets,l.velocity||30);if(l.type==="cartesian_move"){const _=L(l.target);return _.feasible?P(_.joints_deg,l.velocity||30):{success:!1,error:_.error_message}}else{if(l.type==="stop")return D(),{success:!0};if(l.type==="estop")return K(),{success:!0};if(l.type==="clear_fault")return J(),{success:!0}}return{success:!1,error:"Unknown command"}},[]),S=u.useCallback((l,_,v=30)=>{const M=o.jointPositions[l],x=[...o.jointPositions];x[l]=M+_*5;const b=T[l];return x[l]=Math.max(b.min,Math.min(b.max,x[l])),P(x,v)},[]);return{send:u.useCallback((l,_)=>(console.log("[SIMULATED] Message:",l,_),!0),[]),requestIKPreview:h,requestModeSwitch:g,sendMotionCommand:f,jogJoint:S,isSimulated:!0}}const O=500,z=1e4,B=500;function Y(t=null){const n=u.useRef(null),e=u.useRef(null),s=u.useRef(null),a=u.useRef(O),{setConnected:c,setLatency:d,updateFromFirmware:m,updateAlignment:h,updateSafety:g,setIKResult:f,applyModeChange:S,requestModeChange:j}=A(),l=t||`ws://${window.location.host}/ws`,_=u.useCallback(p=>{try{const r=JSON.parse(p.data);if(r.version!==1){console.warn("Unknown message version:",r.version);return}switch(r.timestamp_ms&&d(Date.now()-r.timestamp_ms),r.type){case"STATE_UPDATE":m(r.payload);break;case"ALIGNMENT_STATUS":h(r.payload);break;case"SAFETY_FAULT":g(r.payload);break;case"IK_PREVIEW_RESULT":f(r.payload);break;case"IK_FAILURE":f({feasible:!1,error_code:r.payload.error_code,error_message:r.payload.error_message});break;case"MODE_CHANGE_RESPONSE":S(r.payload);break;case"MODE_STATUS":S({success:!0,current_mode:r.payload.mode});break;default:console.log("Unknown message type:",r.type)}}catch(r){console.error("WebSocket message parse error:",r)}},[m,h,g,f,S,d]),v=u.useCallback(()=>{var p;if(((p=n.current)==null?void 0:p.readyState)!==WebSocket.OPEN)try{n.current=new WebSocket(l),n.current.onopen=()=>{console.log("[WS] Connected"),c(!0),a.current=O,s.current&&(clearTimeout(s.current),s.current=null)},n.current.onclose=()=>{console.log("[WS] Disconnected"),s.current||(s.current=setTimeout(()=>{c(!1),j(!0),console.warn("[WS] Grace period expired - entering safe mode")},B)),e.current=setTimeout(()=>{a.current=Math.min(a.current*2,z),v()},a.current)},n.current.onerror=r=>{console.error("[WS] Error:",r)},n.current.onmessage=_}catch(r){console.error("[WS] Connection failed:",r)}},[l,c,_,j]),M=u.useCallback((p,r)=>{var I;if(((I=n.current)==null?void 0:I.readyState)!==WebSocket.OPEN)return console.warn("[WS] Cannot send - not connected"),!1;const w={version:1,timestamp_ms:Date.now(),type:p,payload:r};return n.current.send(JSON.stringify(w)),!0},[]),x=u.useCallback((p,r,w)=>M("IK_PREVIEW_REQUEST",{target_mm:p.slice(0,3),orientation_deg:p.slice(3,6),seed_joints_deg:r,solver:w}),[M]),b=u.useCallback(p=>M("MODE_CHANGE_REQUEST",{target_mode:p?"SIMULATOR":"HARDWARE",force:!1}),[M]),N=u.useCallback(p=>A.getState().simulatorMode?(console.warn("[WS] Motion command blocked - simulator mode"),!1):M("MOTION_COMMAND",p),[M]);return u.useEffect(()=>(v(),()=>{e.current&&clearTimeout(e.current),s.current&&clearTimeout(s.current),n.current&&n.current.close()}),[v]),{send:M,requestIKPreview:x,requestModeSwitch:b,sendMotionCommand:N}}function Q(){const{simulatorMode:t,hardwareArmed:n,modeChangePending:e,modeChangeError:s,isMoving:a,faultCode:c,estopActive:d}=A(),{requestModeSwitch:m}=Y(),h=!a&&!e&&!d,g=()=>{h&&(m(!t),A.getState().requestModeChange(!t))};let f=null;return a&&(f="Motion in progress"),e&&(f="Switching..."),d&&(f="E-Stop active"),i.jsxs("div",{className:"simulator-toggle",children:[i.jsxs("div",{className:"toggle-container",children:[i.jsxs("button",{className:`mode-button hardware ${t?"":"active"}`,onClick:()=>t&&g(),disabled:!h||!t,children:[i.jsx("span",{className:"mode-icon",children:"âš™ï¸"}),i.jsx("span",{className:"mode-label",children:"HARDWARE"}),n&&!t&&i.jsx("span",{className:"armed-indicator",children:"ARMED"})]}),i.jsx("div",{className:`toggle-switch ${t?"simulator":"hardware"} ${h?"":"disabled"}`,onClick:g,role:"switch","aria-checked":t,children:i.jsx("div",{className:"toggle-thumb"})}),i.jsxs("button",{className:`mode-button simulator ${t?"active":""}`,onClick:()=>!t&&g(),disabled:!h||t,children:[i.jsx("span",{className:"mode-icon",children:"ðŸŽ®"}),i.jsx("span",{className:"mode-label",children:"SIMULATOR"})]})]}),i.jsxs("div",{className:"toggle-status",children:[e&&i.jsx("span",{className:"status-pending",children:"Switching mode..."}),s&&i.jsx("span",{className:"status-error",children:s}),f&&!e&&i.jsx("span",{className:"status-blocked",children:f})]}),!t&&i.jsx("div",{className:"hardware-warning",children:"âš ï¸ Commands will move real motors"})]})}const X=u.lazy(()=>y(()=>import("./RobotSimulator-BLi83Ft4.js"),__vite__mapDeps([0,1,2]))),Z=u.lazy(()=>y(()=>import("./ConnectionsGraph-uyiXOfH1.js"),__vite__mapDeps([3,1,2,4,5]))),ee=[{id:"simulator",label:"3D Simulator",icon:"ðŸ¤–"},{id:"connections",label:"Connections",icon:"ðŸ”—"},{id:"motion",label:"Motion",icon:"ðŸŽ¯"},{id:"diagnostics",label:"Diagnostics",icon:"ðŸ“Š"}];function te(){const[t,n]=u.useState("simulator"),{connected:e,simulatorMode:s,faultCode:a,aligned:c,estopActive:d}=A();return H(),i.jsxs("div",{className:"app-container",children:[i.jsxs("header",{className:"app-header",children:[i.jsxs("div",{className:"header-left",children:[i.jsx("h1",{className:"app-title",children:"ESP32 Robot Arm"}),i.jsx("span",{className:"app-subtitle",children:"Industrial Simulator"})]}),i.jsx("div",{className:"header-center",children:i.jsx(Q,{})}),i.jsxs("div",{className:"header-right",children:[i.jsx(oe,{connected:e}),i.jsx(ne,{estop:d,fault:a!==0,aligned:c})]})]}),i.jsx("nav",{className:"tab-navigation",children:ee.map(m=>i.jsxs("button",{className:`tab-button ${t===m.id?"active":""}`,onClick:()=>n(m.id),children:[i.jsx("span",{className:"tab-icon",children:m.icon}),i.jsx("span",{className:"tab-label",children:m.label})]},m.id))}),i.jsx("main",{className:"main-content",children:i.jsxs(u.Suspense,{fallback:i.jsx(se,{}),children:[t==="simulator"&&i.jsx(X,{}),t==="connections"&&i.jsx(Z,{}),t==="motion"&&i.jsx(ie,{}),t==="diagnostics"&&i.jsx(ae,{})]})}),i.jsxs("footer",{className:"status-bar",children:[i.jsx(R,{label:"Mode",value:s?"SIMULATOR":"HARDWARE"}),i.jsx(R,{label:"Lat",value:`${A.getState().latencyMs}ms`}),i.jsx(R,{label:"Fault",value:`0x${a.toString(16).padStart(8,"0")}`})]})]})}function oe({connected:t}){return i.jsxs("div",{className:`connection-status ${t?"connected":"disconnected"}`,children:[i.jsx("span",{className:"status-dot"}),i.jsx("span",{className:"status-text",children:t?"Connected":"Disconnected"})]})}function ne({estop:t,fault:n,aligned:e}){let s="ok",a="Safe";return t?(s="estop",a="E-STOP"):n?(s="fault",a="FAULT"):e||(s="warning",a="Misaligned"),i.jsxs("div",{className:`safety-indicator ${s}`,children:[i.jsx("span",{className:"safety-icon",children:"âš¡"}),i.jsx("span",{className:"safety-text",children:a})]})}function R({label:t,value:n}){return i.jsxs("div",{className:"status-item",children:[i.jsxs("span",{className:"status-label",children:[t,":"]}),i.jsx("span",{className:"status-value",children:n})]})}function se(){return i.jsxs("div",{className:"loading-spinner",children:[i.jsx("div",{className:"spinner"}),i.jsx("span",{children:"Loading..."})]})}const ie=u.lazy(()=>y(()=>import("./MotionPanel-CVXXJhcS.js"),__vite__mapDeps([6,1,2]))),ae=u.lazy(()=>y(()=>import("./DiagnosticsPanel-B6K82A9o.js"),__vite__mapDeps([7,1,2])));W.createRoot(document.getElementById("root")).render(i.jsx(U.StrictMode,{children:i.jsx(te,{})}));export{H as a,A as u};
